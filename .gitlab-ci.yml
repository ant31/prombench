# Generated from .gitlab-ci.jsonnet 
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN 
---
build-image:
  before_script:
  - docker info
  - docker login -u prombench+gitlabci -p $QUAY_TOKEN quay.io
  image: docker:git
  script:
  - 'docker build  --no-cache -t quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8} . '
  - docker push quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  services:
  - docker:dind
  stage: build_image
  tags:
  - kubernetes
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
cache:
  paths:
  - cache
container-release:
  before_script:
  - docker info
  - docker login -u prombench+gitlabci -p $QUAY_TOKEN quay.io
  image: docker:git
  only:
  - master
  - tags
  script:
  - docker pull quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker tag quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8} quay.io/ant31/prombench:${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker push quay.io/ant31/prombench:${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker pull quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker tag quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8} quay.io/ant31/prombench:alpha
  - docker push quay.io/ant31/prombench:alpha
  services:
  - docker:dind
  stage: docker_release
  tags:
  - kubernetes
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
flake8:
  allow_failure: true
  before_script:
  - cd /opt/prombench
  - pip install flake8
  image: quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  script:
  - make flake8
  stage: tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
mypy_compile:
  before_script:
  - cd /opt/prombench
  - pip install mypy
  image: quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  script:
  - make mypy
  stage: tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
pylint:
  before_script:
  - cd /opt/prombench
  - pip install pylint
  image: quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  script:
  - make pylint
  stage: tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
stages:
- build_image
- tests
- docker_release
unit-tests:
  before_script:
  - cd /opt/prombench
  - pip install -r requirements_test.txt
  image: quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  script:
  - make test
  stage: tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
variables:
  FAILFASTCI_NAMESPACE: failfast-ci
yapf:
  allow_failure: true
  before_script:
  - cd /opt/prombench
  - pip install yapf
  image: quay.io/ant31/prombench:ci-${CI_COMMIT_REF_SLUG}-${SHA8}
  script:
  - make yapf-diff
  stage: tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
